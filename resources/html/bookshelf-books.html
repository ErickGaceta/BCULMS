<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/bootstrap.css" />
    <link rel="stylesheet" href="../css/bootstrap-grid.css" />
    <link rel="stylesheet" href="../css/bootstrap-icons.css" />
  </head>
  <body>
    <!-- SIDEBAR -->
    <aside class="sidebar" role="navigation" aria-label="Main navigation">
      <nav class="nav flex-column">
        <a href="./index.html" class="d-flex justify-content-center mb-5" aria-label="BCULMS Home">
          <img src="../icons/appIcon.png" alt="BCULMS Logo" width="100" height="100">
        </a>
        <a class="nav-link mb-3" href="./index.html" aria-current="page" aria-label="Dashboard">
          <p></p>
          <span class="icon" aria-hidden="true">
            <i class="bi bi-grid-1x2"></i>
          </span>
          <span class="description">Dashboard</span>
        </a>

        <a
          class="nav-link mb-3"
          data-bs-toggle="collapse"
          data-bs-target="#submenuBookshelf"
          role="button"
          aria-expanded="true"
          aria-controls="submenuBookshelf"
          aria-label="Bookshelf menu"
        >
          <p></p>
          <span class="icon" aria-hidden="true">
            <i class="bi bi-book"></i>
          </span>
          <span class="description">
            Bookshelf <i class="bi bi-caret-down" aria-hidden="true"></i>
          </span>
        </a>
        <div class="sub-menu expand mb-1" id="submenuBookshelf">
          <a href="./bookshelf-books.html" class="nav-link mb-2 active" aria-label="Books management">
            <p></p>
            <span class="icon" aria-hidden="true">
              <i class="bi bi-book-fill"></i>
            </span>
            <span class="description">Books</span>
          </a>
          <a href="./bookshelf-copies.html" class="nav-link mb-2" aria-label="Book copies management">
            <p></p>
            <span class="icon" aria-hidden="true">
              <i class="bi bi-book-half"></i>
            </span>
            <span class="description">Copies</span>
          </a>
        </div>

        <!-- Transactions -->
        <a
          class="nav-link mb-3"
          data-bs-toggle="collapse"
          data-bs-target="#submenuTransactions"
          role="button"
          aria-expanded="false"
          aria-controls="submenuTransactions"
        >
          <p></p>
          <span class="icon">
            <i class="bi bi-person-lines-fill"></i>
          </span>
          <span class="description">
            Transactions <i class="bi bi-caret-down"></i>
          </span>
        </a>
        <div class="sub-menu collapse mb-1" id="submenuTransactions">
          <a href="./transactions_borrow.html" class="nav-link mb-2">
            <p></p>
            <span class="icon">
              <i class="bi bi-calendar-range-fill"></i>
            </span>
            <span class="description">Borrows</span>
          </a>
          <a href="./transaction_library.html" class="nav-link mb-2">
            <p></p>
            <span class="icon">
              <i class="bi bi-database-fill-gear"></i>
            </span>
            <span class="description">Library</span>
          </a>
        </div>

        <a class="nav-link mb-3" href="./students.html">
          <p></p>
          <span class="icon">
            <i class="bi bi-person-badge"></i>
          </span>
          <span class="description">Student Page</span>
        </a>

        <!-- Archives -->
        <a
          class="nav-link mb-3"
          data-bs-toggle="collapse"
          data-bs-target="#submenuArchives"
          role="button"
          aria-expanded="false"
          aria-controls="submenuArchives"
        >
          <p></p>
          <span class="icon" aria-hidden="true">
            <i class="bi bi-archive"></i>
          </span>
          <span class="description">
            Archives <i class="bi bi-caret-down" aria-hidden="true"></i>
          </span>
        </a>
        <div class="sub-menu collapse mb-1" id="submenuArchives">
          <a href="./archived-books.html" class="nav-link mb-2">
            <p></p>
            <span class="icon" aria-hidden="true">
              <i class="bi bi-archive-fill"></i>
            </span>
            <span class="description">Archived Books</span>
          </a>
          <a href="./archived-students.html" class="nav-link mb-2">
            <p></p>
            <span class="icon" aria-hidden="true">
              <i class="bi bi-person-x-fill"></i>
            </span>
            <span class="description">Archived Students</span>
          </a>
        </div>
      </nav>
    </div>

    <!-- MAIN -->
    <main class="main-content" role="main">
      <div id="image-container" aria-hidden="true">
        <img src="../images/bcu_building2.jpg" alt="Bicol University Campus Building" id="background" />
      </div>
      <header class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-6">Books Management</h1>
        <div class="btn-group">
          <button type="button"
                  class="btn btn-secondary dropdown-toggle"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  aria-label="Filter books by department">
            <i class="bi bi-funnel me-2" aria-hidden="true"></i>
            Filter
          </button>
          <ul class="dropdown-menu" id="departmentFilter" aria-label="Department filter options"></ul>
        </div>
      </header>
      
      <div class="table-responsive">
        <div id="pager-top" class="d-flex justify-content-center mb-3" role="navigation" aria-label="Top pagination"></div>
        <table class="table table-striped table-hover align-middle" role="table" aria-label="Books catalog">
          <thead class="table-light">
            <tr>
              <th scope="col">Book Title</th>
              <th scope="col">Author</th>
              <th scope="col">Publication Date</th>
              <th scope="col">Department</th>
              <th scope="col">Copies</th>
            </tr>
          </thead>
          <tbody id="booksTableBody" role="rowgroup">
            <tr>
              <td colspan="5" class="text-center text-muted">
                <i class="bi bi-book me-2" aria-hidden="true"></i>
                Loading books...
              </td>
            </tr>
          </tbody>
        </table>
        <div id="pager-bottom" class="d-flex justify-content-center mt-3" role="navigation" aria-label="Bottom pagination"></div>
      </div>

      <button type="button"
              id="addBookBtn"
              class="btn btn-primary position-fixed bottom-0 end-0 m-4 rounded-circle shadow-lg"
              data-bs-toggle="modal"
              data-bs-target="#addBookContent"
              aria-label="Add new books to the library">
        <i class="bi bi-plus-lg fs-4" aria-hidden="true"></i>
      </button>

      <div class="modal fade" id="addBookContent" tabindex="-1" aria-labelledby="addBookModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="addBookModalLabel">
                <i class="bi bi-book me-2" aria-hidden="true"></i>
                Add New Book
              </h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close modal"
              ></button>
            </div>
            <div class="modal-header bg-light border-bottom">
              <div class="btn-group" role="group" aria-label="Book addition mode">
                <input type="radio" class="btn-check" name="addMode" id="singleMode" value="single" checked>
                <label class="btn btn-outline-primary btn-sm" for="singleMode">Single Book</label>
                <input type="radio" class="btn-check" name="addMode" id="bulkMode" value="bulk">
                <label class="btn btn-outline-primary btn-sm" for="bulkMode">Bulk Add</label>
              </div>
              <div class="form-text ms-auto">
                <small id="modeHelpText" aria-live="polite">Add books one at a time</small>
              </div>
            </div>
            <div class="modal-body">
              <!-- Single Book Mode -->
              <div id="singleBookMode">
                <div class="input-group input-group-sm mb-3">
                  <span class="input-group-text">Title</span>
                  <input name="title" type="text" class="form-control" required />
                </div>
                <div class="input-group input-group-sm mb-3">
                  <span class="input-group-text">Author</span>
                  <input
                    name="author"
                    type="text"
                    class="form-control"
                    required
                  />
                </div>
                <div class="input-group input-group-sm mb-3">
                  <span class="input-group-text">Date Format</span>
                  <select
                    name="date_format"
                    id="dateFormatSelect"
                    class="form-control"
                    required
                  >
                    <option value="full">Full Date (YYYY-MM-DD)</option>
                    <option value="month">Month & Year (YYYY-MM)</option>
                    <option value="year">Year Only (YYYY)</option>
                  </select>
                </div>
                <div class="input-group input-group-sm mb-3">
                  <span class="input-group-text">Publication Date</span>
                  <input
                    name="publication_date"
                    id="publicationDateInput"
                    type="date"
                    class="form-control"
                    required
                  />
                </div>
                <div class="input-group input-group-sm mb-3">
                  <span class="input-group-text">Type</span>
                  <select name="type" class="form-control" required>
                    <option value="Book">Book</option>
                    <option value="Research Paper">Research Paper</option>
                  </select>
                </div>
                <div class="input-group input-group-sm mb-3">
                  <span class="input-group-text">Department</span>
                  <select
                    name="department_id"
                    id="departmentSelect"
                    class="form-control"
                    required
                  >
                    <option value="">Loading...</option>
                  </select>
                </div>
                <div class="input-group input-group-sm mb-3">
                  <span class="input-group-text">Copies</span>
                  <input
                    name="copies"
                    type="number"
                    class="form-control"
                    required
                  />
                </div>
              </div>

              <!-- Bulk Add Mode -->
              <div id="bulkBookMode" style="display: none;">
                <div class="alert alert-info">
                  <h6><i class="bi bi-info-circle"></i> Bulk Add Instructions</h6>
                  <p class="mb-2">Enter book details in the following format, one book per line:</p>
                  <code>Title | Author | Publication Date | Type | Department | Copies</code>
                  <p class="mt-2 mb-0"><strong>Example:</strong></p>
                  <code>Introduction to Programming | John Doe | 2023-01-15 | Book | CS | 3</code>
                </div>
                <div class="mb-3">
                  <label for="bulkBooksTextarea" class="form-label">Book Entries</label>
                  <textarea 
                    id="bulkBooksTextarea" 
                    class="form-control" 
                    rows="10" 
                    placeholder="Enter books, one per line...&#10;Title | Author | Date | Type | Department | Copies&#10;&#10;Example:&#10;Introduction to Programming | John Doe | 2023-01-15 | Book | CS | 3&#10;Data Structures | Jane Smith | 2022-06-20 | Book | CS | 2"
                  ></textarea>
                </div>
                <div class="mb-3">
                  <label for="bulkDateFormat" class="form-label">Date Format</label>
                  <select id="bulkDateFormat" class="form-control">
                    <option value="full">Full Date (YYYY-MM-DD)</option>
                    <option value="month">Month & Year (YYYY-MM)</option>
                    <option value="year">Year Only (YYYY)</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="button" class="btn btn-primary" id="saveBookBtn">
                Save Book
              </button>
              <button type="button" class="btn btn-success" id="saveBulkBooksBtn" style="display: none;">
                Save Books
              </button>
            </div>
          </div>
        </div>
      </div>

      <script>
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.toISOString().slice(0, 7); // YYYY-MM
        const currentDate = today.toISOString().split("T")[0]; // YYYY-MM-DD

        // Set initial max date for the date input
        const dateInput = document.getElementById("publicationDateInput");
        dateInput.max = currentDate;

        // Add validation for year input (only clamp once 4 digits entered)
        dateInput.addEventListener("input", function () {
          if (this.type === "number") {
            const raw = String(this.value || "");
            if (!raw || raw.length < 4) {
              return;
            }
            const yearValue = parseInt(raw, 10);
            if (Number.isNaN(yearValue)) {
              return;
            }
            if (yearValue > currentYear) {
              this.value = currentYear;
            } else if (yearValue < 1000) {
              this.value = 1000;
            }
          }
        });

        // Prevent typing future years
        dateInput.addEventListener("blur", function () {
          if (this.type === "number") {
            const yearValue = parseInt(this.value);
            if (yearValue > currentYear) {
              this.value = currentYear;
              showModalAlert(
                `Publication year cannot be in the future. Maximum year is ${currentYear}.`,
                "warning"
              );
            }
          }
        });

        document
          .getElementById("dateFormatSelect")
          .addEventListener("change", function () {
            const format = this.value;

            switch (format) {
              case "full":
                dateInput.type = "date";
                dateInput.placeholder = "YYYY-MM-DD";
                dateInput.max = currentDate;
                dateInput.removeAttribute("min");
                dateInput.step = "";
                dateInput.removeAttribute("inputmode");
                break;
              case "month":
                dateInput.type = "month";
                dateInput.placeholder = "YYYY-MM";
                dateInput.max = currentMonth;
                dateInput.removeAttribute("min");
                dateInput.step = "";
                dateInput.removeAttribute("inputmode");
                break;
              case "year":
                dateInput.type = "number";
                dateInput.placeholder = "YYYY";
                dateInput.min = "1000";
                dateInput.max = currentYear.toString();
                dateInput.step = "1";
                dateInput.setAttribute("inputmode", "numeric");
                break;
            }

            dateInput.value = "";
          });

        // Mode switching functionality
        function switchAddMode(mode) {
          const singleMode = document.getElementById('singleBookMode');
          const bulkMode = document.getElementById('bulkBookMode');
          const saveBookBtn = document.getElementById('saveBookBtn');
          const saveBulkBtn = document.getElementById('saveBulkBooksBtn');
          const helpText = document.getElementById('modeHelpText');

          if (mode === 'bulk') {
            singleMode.style.display = 'none';
            bulkMode.style.display = 'block';
            saveBookBtn.style.display = 'none';
            saveBulkBtn.style.display = 'block';
            helpText.textContent = 'Add multiple books at once';
          } else {
            singleMode.style.display = 'block';
            bulkMode.style.display = 'none';
            saveBookBtn.style.display = 'block';
            saveBulkBtn.style.display = 'none';
            helpText.textContent = 'Add books one at a time';
          }
        }

        // Add event listeners for mode radio buttons
        document.getElementById('singleMode').addEventListener('change', function() {
          if (this.checked) switchAddMode('single');
        });

        document.getElementById('bulkMode').addEventListener('change', function() {
          if (this.checked) switchAddMode('bulk');
        });
        
        document.addEventListener("DOMContentLoaded", () => {
          const params = new URLSearchParams(window.location.search);
          const modalId = params.get("modal");

          if (modalId) {
            const modalEl = document.getElementById(modalId);
            if (modalEl) {
              const modal = new bootstrap.Modal(modalEl);
              modal.show();
            }
          }

          // Add event listener for bulk save button
          document.getElementById('saveBulkBooksBtn').addEventListener('click', async function() {
            await addBooksToDB();
          });
        });
      </script>
    </main>

    <script src="../js/bootstrap.bundle.js"></script>
    <script src="../js/neutralino.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/sql-wasm.js"></script>
    <script src="../js/database-connection.js"></script>
    <script src="../js/seed-tables.js"></script>
    <script src="../js/create-table.js"></script>
    <script src="../js/database-operations.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/frontend-operations.js"></script>
    <script src="../js/library-operations.js"></script>
    <script src="../js/filter.js"></script>
    <script src="../js/getFromDB.js"></script>
    <script src="../js/insertIntoDB.js"></script>
    <script src="../js/renderer.js"></script>
    <script src="../js/search.js"></script>
    <script src="../js/popup.js"></script>
    <script src="../js/app.js"></script>
  </body>
</html>
